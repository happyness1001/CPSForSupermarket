<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0072)pay.html?selectedItemSpecIds=cake-1004-spec-1 -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<meta name="viewport" content="width=device-width, initial-scale=1.0 ,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link href="static/css/amazeui.css" rel="stylesheet" type="text/css">
	<link href="static/css/admin.css" rel="stylesheet" type="text/css">
	<link href="static/css/demo.css" rel="stylesheet" type="text/css">
	<link href="static/css/personal.css" rel="stylesheet" type="text/css">
	<link href="static/css/systyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/cartstyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/jsstyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/lee.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="static/css/bootstrap.css" />
	<!-- 引入样式 -->
	<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
	<script type="text/javascript" src="static/js/jquery-3.4.1.min.js" ></script>
	<script type="text/javascript" src="static/js/bootstrap.js" ></script>
</head>

<body>
<div id="container">
	<div class="concent" style="margin-top: 35px;">
		<div class="paycont">
			<div class="user-info">
				<div class="am-u-md-12" >
					<div class="am-cf am-padding">
						<div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">退换货申请</strong></div>
					</div>
					<form class="am-form am-form-horizontal">
						<div class="am-form-group"><label for="orderId" class="am-form-label">订单ID</label>
							<div class="am-form-content"><input type="text" id="orderId" :value="returnRequest.orderId" maxlength="12" readonly></div>
						</div>
						<div class="am-form-group"><label for="returnReason" class="am-form-label">退款原因</label>
							<div class="am-form-content"><select id="returnReason">
								<option value="选择退款原因">选择退款原因</option>
								<template v-if="refund==0">
									<option value="不喜欢/不想要">不喜欢/不想要</option>
									<option value="多拍/错拍">多拍/错拍</option>
									<option value="与商家协商一致退款">与商家协商一致退款</option>
									<option value="空包裹">空包裹</option>
									<option value="发货慢">发货慢</option>
									<option value="快递/物流一直未送到">快递/物流一直未送到</option>
									<option value="货物破损已拒签">货物破损已拒签</option>
								</template>
								<template v-if="refund==1">
									<option value="与商家协商一致退款">与商家协商一致退款</option>
									<option value="卖家发错货">卖家发错货</option>
									<option value="大小/尺寸与商品描述不符">大小/尺寸与商品描述不符</option>
									<option value="颜色/图案/款式与商品描述不符">颜色/图案/款式与商品描述不符</option>
									<option value="货物破损/或腐烂">货物破损/或腐烂</option>
									<option value="做工粗糙/有瑕疵">做工粗糙/有瑕疵</option>
									<option value="质量问题">质量问题</option>
									<option value="少件/漏发">少件/漏发</option>
									<option value="包装/商品破损/污渍/裂痕/变形">包装/商品破损/污渍/裂痕/变形</option>
								</template>

							</select></div>
						</div>
						<div class="am-form-group"><label for="returnMoneyAmount" class="am-form-label">退款金额</label>
							<div class="am-form-content"><input type="text" id="returnMoneyAmount" :value="returnRequest.returnMoneyAmount" maxlength="12"></div>
						</div>
						<template v-if="refund">
							<div class="am-form-group"><label class="am-form-label">类型</label>
								<div class="am-form-content">
									<input type="radio" name="radio" class="ml-3" id="returnGoods" value="2" @click="check('2')" checked/>
									<label for="returnGoods" class="">退货</label>
									<input type="radio" name="radio" class="ml-3" id="changeGoods" value="3" @click="check('3')"/>
									<label for="changeGoods" class="">换货</label>
								</div>
							</div>
							<div class="am-form-group"><label for="additionalDesp" class="am-form-label">退货说明</label>
								<div class="am-form-content"><input type="text" id="additionalDesp" :value="returnRequest.additionalDesp"></div>
							</div>
							<div class="am-form-group"><label for="image-preview" class="am-form-label">退货凭证</label>
								<div class="am-form-content">
									<div class="instrument">
										<img src="./static/images/picture.png" width="30px" height="30px" onclick="file.click()" style="margin-left: 0px">
										<input type="file" id="file" name="upload_image" accept="image/gif, image/jpeg, image/png, image/jpg" style="display:none">
									</div>
									<img id="image-preview">
								</div>
							</div>
						</template>

						<div class="am-form-group theme-poptit">
							<div class="am-u-sm-9 am-u-sm-push-3">
								<div class="am-btn am-btn-default" onclick="save()">提交</div>
								<div class="am-btn am-btn-success" @click="backward()">取消</div>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="clear"></div>

		</div>
	</div>
</div>
<script type="text/javascript" src="static/js/utils.js" ></script>
<script type="text/javascript" src="static/js/cookie_utils.js" ></script>
<script type="text/javascript" src="static/js/vue.js" ></script>
<script type="text/javascript" src="static/js/axios.min.js" ></script>
<script type="text/javascript" src="static/js/base.js" ></script>
<script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.18.0/js/md5.js"></script>
<script type="text/javascript">
	var vm = new Vue({
		el:"#container",
		data:{
			returnRequest:{
				"orderId":"",
				"returnType":'1',
				"returnReason":"",
				"returnMoneyAmount":"",
				"additionalDesp":"",
				"returnEvidence":""
			},
			orderId:"",
			order:"",
			reconciliation:"",
			refund:1,
			money:"",
			imgName:""
		},
		created:function(){
			// this.returnRequest.orderId = "78f012fd85f74475b0a9b7e673e38fe3";
			// this.orderId = "78f012fd85f74475b0a9b7e673e38fe3";
			this.returnRequest.orderId = getUrlParam("orderId");
			this.orderId = getUrlParam("orderId");
			var url = baseUrl + "order/getOrder/"+this.orderId;
			axios({
				url: url,
				method: "get",
				headers: {
					token: getCookieValue("token")
				}
			}).then((res) => {
				if (res.data.code == 10000) {
					this.order = res.data.data;
					if(this.order.status=="2"||this.order.status=="3"){
						this.refund = 0;
						this.returnRequest.returnType='0'
					}
					console.log("订单信息",this.order);
				}
			});

			var url2 = baseUrl + "order/getReconciliation/"+this.orderId;
			axios({
				url: url2,
				method: "get",
				headers: {
					token: getCookieValue("token")
				}
			}).then((res) => {
				if (res.data.code == 10000) {
					this.reconciliation = res.data.data;
					console.log("对账金额",this.reconciliation);
					if(this.reconciliation.length>1){
						this.returnRequest.returnMoneyAmount = this.reconciliation.amountPaid;
						this.money = this.reconciliation.amountPaid;
					}else{
						this.returnRequest.returnMoneyAmount = this.order.actualAmount;
						this.money = this.order.actualAmount;
					}

				}
			});
		},
		methods: {
			check:function (value){
			    this.returnRequest.returnType = value;
			},
			backward : function (){

				window.location.href = "user-orderlist.html";
			},
			submit:function (){
				// save();
				var myselect = document.getElementById("returnReason");
				var index = myselect.selectedIndex;
				var reason = myselect.options[index].text;
				if(reason=="选择退款原因"){
					alert("请选择退款原因");
					return;
				}else {
					this.returnRequest.returnReason = reason;
				}
				this.returnRequest.returnMoneyAmount = document.getElementById("returnMoneyAmount").value;
				if(this.returnRequest.returnMoneyAmount > this.reconciliation.amountPaid){
					alert("退款金额错误，请重新填写");
					return;
				}
				if(this.refund==1){
					this.returnRequest.additionalDesp = document.getElementById("additionalDesp").value;
					this.returnRequest.returnEvidence = this.imgName;
					console.log("hh",this.returnRequest.returnEvidence);
				}else{
					this.returnRequest.additionalDesp = "仅退款";
					this.returnRequest.returnEvidence = "仅退款";
				}

				if(this.returnRequest.returnType=='2'){
					this.returnRequest.returnMoneyAmount=0;
				}
				var url3 = baseUrl + "order/returnRequest";
				axios({
					url: url3,
					method: "post",
					headers: {
						token: getCookieValue("token")
					},
					data: this.returnRequest
				}).then((res) => {
					if (res.data.code == 10000) {
						alert("提交成功！");
						var status = "";
						if(this.order.status=="2"){
							status = "12";
						}else if(this.order.status=="3")
						{
							status = "13";
						}else if(this.order.status=="4")
						{
							status = "14";
						}else if(this.order.status=="5")
						{
							status = "15";
						}else
						{
							alert("订单状态异常，请重试");
							return;
						}
						var url1 = baseUrl+"order/status/"+this.returnRequest.orderId;
						axios({
							url:url1,
							method:"put",
							headers:{
								token:getCookieValue("token")
							},
							params:{
								status:status
							}
						}).then((res)=>{
							console.log(res.data.data);
							window.location.href = "user-orderlist.html";
						});
					}
				});
			}
		},
	});

</script>
<script type="text/javascript">
	let fileInput = document.getElementById('file');
	let info = document.getElementById('info');
	let preview = document.getElementById('image-preview');
	let test = 0;
	// 监听change事件:
	fileInput.addEventListener('change', function() {
		// 清除背景图片:
		test = 1;
		preview.style.backgroundImage = '';
		if (!fileInput.value) {
			info.innerHTML = '没有选择文件';
			return;
		}
		let file = fileInput.files[0];
		let size = file.size;
		if (size >= 1 * 1024 * 1024) {
			alert('文件大小超出限制');
			info.innerHTML = '文件大小超出限制';
			return false;
		}
		if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
			alert('不是有效的图片文件!');
			return;
		}
		console.log( "res.data.data");
		// 读取文件:
		let reader = new FileReader();
		reader.onload = function(e) {
			let data = e.target.result;
			console.log(preview, 'a标签')
			preview.src = data
		};
		// 以DataURL的形式读取文件:
		reader.readAsDataURL(file);

	});

	function save() {
		var text = "";
		if(test){
			var formdata = new FormData();
			formdata.append("image", fileInput.files[0]);
			console.log(fileInput.files[0].name);
			var url5 = baseUrl+"order/sendImg"
			axios({
				url:url5,
				method:"put",
				contentType:"multipart/form-data",
				data:formdata,

			}).then((res)=>{
				test = 0;
				vm.imgName = res.data.data;
				vm.submit();
			});
		}else {
			vm.imgName = "";
			vm.submit();
		}
		// console.log("图片名称2",text);
		// return text;
	}
</script>
</body>

</html>