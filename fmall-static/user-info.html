<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0072)pay.html?selectedItemSpecIds=cake-1004-spec-1 -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<meta name="viewport" content="width=device-width, initial-scale=1.0 ,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link href="static/css/amazeui.css" rel="stylesheet" type="text/css">
	<link href="static/css/admin.css" rel="stylesheet" type="text/css">
	<link href="static/css/demo.css" rel="stylesheet" type="text/css">
	<link href="static/css/personal.css" rel="stylesheet" type="text/css">
	<link href="static/css/systyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/cartstyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/jsstyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/lee.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="static/css/bootstrap.css" />
	<!-- 引入样式 -->
	<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
	<script type="text/javascript" src="static/js/jquery-3.4.1.min.js" ></script>
	<script type="text/javascript" src="static/js/bootstrap.js" ></script>
</head>

<body>
<div id="container">
	<div class="concent" style="margin-top: 35px;">
		<div class="paycont">
			<div class="user-info">
				<form method="post" enctype="multipart/form-data" id="file_upload" style="overflow: hidden;;display: none;">
					<p>图片预览：</p>
					<img id="image-preview">
					<p>
						<input type="file" id="file" name="upload_image" accept="image/gif, image/jpeg, image/png, image/jpg">
						<input type="button" value="更换头像" onclick="save()" />
					</p>
					<p id="info"></p>
				</form>
				<div class="am-u-md-12" style="overflow: hidden;;display: none;" id="div2">
					<div class="am-cf am-padding">
						<div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">修改密码</strong></div>
					</div>
					<form class="am-form am-form-horizontal">
						<div class="am-form-group"><label for="oldPassword" class="am-form-label">旧密码</label>
							<div class="am-form-content"><input type="text" id="oldPassword" value="" maxlength="11"></div>
						</div>
						<div class="am-form-group"><label for="newPassword" class="am-form-label">新密码</label>
							<div class="am-form-content"><input id="newPassword" value="" maxlength="11"></div>
						</div>
						<div class="am-form-group"><label for="newPassword2" class="am-form-label">新密码</label>
							<div class="am-form-content"><input id="newPassword2" value="" maxlength="11"></div>
						</div>
						<div class="am-form-group theme-poptit">
							<div class="am-u-sm-9 am-u-sm-push-3">
								<div class="am-btn am-btn-danger" @click="savePassword()">保存</div>
								<div class="am-btn am-btn-danger" @click="showOrHide2()">取消</div>
							</div>
						</div>
					</form>
				</div>
				<div class="am-u-md-12" style="overflow: hidden;;display: none;" id="div1">
					<div class="am-cf am-padding">
						<div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">修改个人信息</strong></div>
					</div>
					<form class="am-form am-form-horizontal">
						<div class="am-form-group"><label for="username" class="am-form-label">用户名</label>
							<div class="am-form-content"><input type="text" id="username" :value="user.username" maxlength="12"></div>
						</div>
						<div class="am-form-group"><label for="nickname" class="am-form-label">昵称</label>
							<div class="am-form-content"><input type="text" id="nickname" :value="user.nickname" maxlength="12"></div>
						</div>
						<div class="am-form-group"><label for="realname" class="am-form-label">姓名</label>
							<div class="am-form-content"><input type="text" id="realname" :value="user.realname" maxlength="12"></div>
						</div>
						<div class="am-form-group"><label for="userSex" class="am-form-label">性别</label>
							<div class="am-form-content"><input type="text" id="userSex" :value="user.userSex" maxlength="12"></div>
						</div>
						<div class="am-form-group"><label class="am-form-label">出生日期</label>
							<div class="am-form-content"><input id="myDate" type="date" :placeholder="请选择日期" maxlength="12"/></div>
						</div>
						<div class="am-form-group"><label for="userMobile" class="am-form-label">电话</label>
							<div class="am-form-content"><input type="text" id="userMobile" :value="user.userMobile" maxlength="12"></div>
						</div>
						<div class="am-form-group"><label for="userEmail" class="am-form-label">电子邮件</label>
							<div class="am-form-content"><input type="text" id="userEmail" :value="user.userEmail" maxlength="20"></div>
						</div>
						<div class="am-form-group theme-poptit">
							<div class="am-u-sm-9 am-u-sm-push-3">
								<div class="am-btn am-btn-danger" @click="saveInformation()">保存</div>
								<div class="am-btn am-btn-danger" @click="showOrHide()">取消</div>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="clear"></div>
			<table class="table" id="tab">
				<th>个人信息</th>
				<tr>
					<td>用户名</td>
					<td>{{user.username}}</td>
				</tr>
				<tr>
					<td>昵称</td>
					<td>{{user.nickname}}</td>
				</tr>
				<tr>
					<td>姓名</td>
					<td>{{user.realname}}</td>
				</tr>
				<tr>
					<td>性别</td>
					<td>{{user.userSex}}</td>
				</tr>
				<tr>
					<td>出生日期</td>
					<td>{{brith}}</td>
				</tr>
				<tr>
					<td>电话</td>
					<td>{{user.userMobile}}</td>
				</tr>
				<tr>
					<td>电子邮件</td>
					<td>{{user.userEmail}}</td>
				</tr>
				<tr>
					<td>保证金</td>
					<td>¥  {{user.securityDeposit}}</td>
				</tr>
				<tr>

					<td>
						<button class="btn btn-danger btn-xs" @click="updateUser()">修改个人信息</button>
					</td>
					<td>
						<button id="cid" class="btn btn-success btn-xs" @click="updatePassword()">修改密码</button>
					</td>
					<td>
						<button  class="btn btn-success btn-xs" @click="changeImage()">更换头像</button>
					</td>

				</tr>
			</table>
			<div class="clear"></div>
		</div>
	</div>
</div>
<script type="text/javascript" src="static/js/utils.js" ></script>
<script type="text/javascript" src="static/js/cookie_utils.js" ></script>
<script type="text/javascript" src="static/js/vue.js" ></script>
<script type="text/javascript" src="static/js/axios.min.js" ></script>
<script type="text/javascript" src="static/js/base.js" ></script>
<script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.18.0/js/md5.js"></script>
<script type="text/javascript">
	var vm = new Vue({
		el:"#container",
		data:{
			user:"",
			brith:"",
			isRight:"true",
			information:{
				"nickname": "",
				"password": "",
				"realname": "",
				"userBirth": "",
				"userEmail": "1111",
				"userId": "",
				"userImg": "",
				"userMobile": "",
				"userModtime": "",
				"userRegtime": "",
				"userSex": "",
				"username": ""
			}
		},
		created:function(){
			//1.根据当前用户id查询收货地址信息
			var userId = getCookieValue("userId");
			var token = getCookieValue("token");
			var url1 = baseUrl+"user/getUser/"+userId;
			axios({
				url:url1,
				method:"get",
				headers:{
					token:token
				}
			}).then((res)=>{
				if(res.data.code == 20001 || res.data.code == 20002){
					//跳转登录
				}else if(res.data.code == 10000){
					console.log( res.data.data);
					this.user = res.data.data;
					this.brith = this.user.userBirth.toString();
				}
			});
		},
		methods: {
			updateUser: function () {
				var divs = document.getElementById("div1");
				divs.style.display = "";
			},
			updatePassword: function () {
				var divs = document.getElementById("div2");
				divs.style.display = "";
			},
			showOrHide: function () {
				var divs = document.getElementById("div1");
				divs.style.display = "none";
			},
			showOrHide2: function () {
				var divs = document.getElementById("div2");
				divs.style.display = "none";
			},
			changeImage: function () {
				var divs = document.getElementById("file_upload");
				divs.style.display = "";
			},
			saveInformation: function () {
				this.information.username = document.getElementById("username").value;
				this.information.nickname = document.getElementById("nickname").value;
				this.information.realname = document.getElementById("realname").value;
				this.information.userSex = document.getElementById("userSex").value;
				var x = document.getElementById("myDate").value;
				this.information.userBirth = new Date(x);
				this.information.userMobile = document.getElementById("userMobile").value;
				this.information.userEmail = document.getElementById("userEmail").value;
				var reg =/^0?1[3|4|5|6|7|8][0-9]\d{8}$/;
				if(this.information.username==""||this.information.nickname==""||this.information.realname==""){
					alert("请输入完整的信息");
					return;
				}
				console.log(this.information.userSex);
				if(!(this.information.userSex=="男"||this.information.userSex=="女")){
					alert("性别输入错误！");
					return ;
				}
				if(x == ""||x==null){
					alert("请输入正确的出生日期！");
					return ;
				}
				var now = new Date();
				if(this.information.userBirth >=now){
					alert("请选择正确的出生日期");
					return;
				}
				if(!reg.test(this.information.userMobile)||this.information.userMobile==""){
					alert("请输入正确的手机号码！");
					return ;
				}
				var reg=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
				//文本框不为空，并且验证邮箱正则成功，给出正确提示
				if(this.information.userEmail == "" || this.information.userEmail.search(reg)==-1)
				{
					alert("请输入正确的电子邮件！");
					return ;
				}

				this.information.userId = getCookieValue("userId");
				console.log("个人信息",this.information)
				var token = getCookieValue("token");
				var divs = document.getElementById("div1");
				divs.style.display = "none";
				alert(this.information.userBirth);
				var url5 = baseUrl+"user/updateUser"
				axios({
					url:url5,
					method:"put",
					headers:{
						token:token
					},
					data: this.information
				}).then((res)=>{
					if(res.data.code == 10000){
						layer.msg("修改信息成功！");
					}else if(res.data.code == 10001){
						layer.msg("修改信息失败！");
					}else{
						var str = "";
						if(res.data.code == 20001){
							str = "请先登录！";
						}else if(res.data.code == 20002){
							str = "登录过期，请重新登录！";
						}
						var loginUrl = "login.html?"+params;

						//跳转到登录页面
						window.location.href= encodeURI(loginUrl);
					}

				});
				location.reload([true]);

			},
			savePassword: function () {

				var oldPassword = document.getElementById("oldPassword").value;
				console.log(oldPassword.length);
				var newPassword = document.getElementById("newPassword").value;
				console.log(newPassword.length);
				var newPassword2 = document.getElementById("newPassword2").value;
				console.log(newPassword2.length);
				if( md5(oldPassword)!= this.user.password){
					alert("密码错误，请重新输入！")
					this.isRight = "false";
				}
				if(newPassword!=newPassword2){
					alert("两次密码不一致，请重新输入！")
					this.isRight = "false";
				}
				if(newPassword.length<6 || newPassword.length>16){
					alert("密码应为6~16位，请重新输入！")
					this.isRight = "false";
				}
				if(this.isRight){
					var divs = document.getElementById("div2");
					divs.style.display = "none";
					this.information.username = this.user.username;
					this.information.nickname = this.user.nickname;
					this.information.realname = this.user.realname;
					this.information.userSex = this.user.userSex;
					this.information.userBirth = this.user.userBirth;
					this.information.userMobile = this.user.userMobile;
					this.information.userEmail = this.user.userEmail;
					this.information.password(newPassword);
					this.information.userId = getCookieValue("userId");
					var token = getCookieValue("token");
					var url5 = baseUrl+"user/updateUser"
					axios({
						url:url5,
						method:"put",
						headers:{
							token:token
						},
						data: this.information
					}).then((res)=>{
						if(res.data.code == 10000){
							layer.msg("修改信息成功！");
							alert("hh")
						}else if(res.data.code == 10001){
							layer.msg("修改信息失败！");
						}else{
							var str = "";
							if(res.data.code == 20001){
								str = "请先登录！";
							}else if(res.data.code == 20002){
								str = "登录过期，请重新登录！";
							}
							var loginUrl = "login.html?"+params;

							//跳转到登录页面
							window.location.href= encodeURI(loginUrl);
						}

					});
				}

			},
		}
	});

</script>
<script type="text/javascript">
	let fileInput = document.getElementById('file');
	let info = document.getElementById('info');
	let preview = document.getElementById('image-preview');
	// 监听change事件:
	fileInput.addEventListener('change', function() {
		// 清除背景图片:
		preview.style.backgroundImage = '';
		if (!fileInput.value) {
			info.innerHTML = '没有选择文件';
			return;
		}
		let file = fileInput.files[0];
		let size = file.size;
		if (size >= 1 * 1024 * 1024) {
			alert('文件大小超出限制');
			info.innerHTML = '文件大小超出限制';
			return false;
		}
		// 获取File信息:
		info.innerHTML = `文件名称:  + ${file.name}<br>文件大小: ${file.size} <br>上传时间: ${file.lastModifiedDate}`;
		if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
			alert('不是有效的图片文件!');
			return;
		}
		console.log( "res.data.data");
		// 读取文件:
		let reader = new FileReader();
		reader.onload = function(e) {
			let data = e.target.result;
			console.log(preview, 'a标签')
			preview.src = data
		};
		// 以DataURL的形式读取文件:
		reader.readAsDataURL(file);

	});

	function save() {
		var formdata = new FormData();
		// formdata.append("name", fileInput.files[0].name);
		formdata.append("image", fileInput.files[0]);
		console.log(fileInput.files[0].name);
		var divs = document.getElementById("file_upload");
		divs.style.display = "none";
		var token = getCookieValue("token");
		var url5 = baseUrl+"user/changeAvatar/9"
		axios({
			url:url5,
			method:"put",
			contentType:"multipart/form-data",
			headers:{
				token:token
			},
			data:formdata,

		}).then((res)=>{
			if(res.data.code == 10000){
				alert("更换头像成功！");
			}else if(res.data.code == 10001){
				layer.msg("更换头像失败！");
			}else{
				var str = "";
				if(res.data.code == 20001){
					str = "请先登录！";
				}else if(res.data.code == 20002){
					str = "登录过期，请重新登录！";
				}
				var loginUrl = "login.html?"+params;

				//跳转到登录页面
				window.location.href= encodeURI(loginUrl);
			}
			location.reload([true]);
		});
	}
</script>

</body>

</html>