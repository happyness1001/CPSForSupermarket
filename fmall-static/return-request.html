<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0072)pay.html?selectedItemSpecIds=cake-1004-spec-1 -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<meta name="viewport" content="width=device-width, initial-scale=1.0 ,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link href="static/css/amazeui.css" rel="stylesheet" type="text/css">
	<link href="static/css/admin.css" rel="stylesheet" type="text/css">
	<link href="static/css/demo.css" rel="stylesheet" type="text/css">
	<link href="static/css/personal.css" rel="stylesheet" type="text/css">
	<link href="static/css/systyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/cartstyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/jsstyle.css" rel="stylesheet" type="text/css">
	<link href="static/css/lee.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="static/css/bootstrap.css" />
	<!-- 引入样式 -->
	<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
	<script type="text/javascript" src="static/js/jquery-3.4.1.min.js" ></script>
	<script type="text/javascript" src="static/js/bootstrap.js" ></script>
</head>

<body>
<div id="container">
	<div class="concent" style="margin-top: 35px;">
		<div class="paycont">
			<div class="user-info">
				<div class="am-u-md-12" >
					<div class="am-cf am-padding">
						<div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">退换货申请</strong></div>
					</div>
					<form class="am-form am-form-horizontal">
						<div class="am-form-group"><label for="orderId" class="am-form-label">订单ID</label>
							<div class="am-form-content"><input type="text" id="orderId" :value="returnRequest.orderId" maxlength="12" readonly></div>
						</div>
						<div class="am-form-group"><label for="returnReason" class="am-form-label">退款原因</label>
							<div class="am-form-content"><input type="text" id="returnReason" :value="returnRequest.returnReason" maxlength="12"></div>
						</div>
						<div class="am-form-group"><label for="returnMoneyAmount" class="am-form-label">退款金额</label>
							<div class="am-form-content"><input type="text" id="returnMoneyAmount" :value="returnRequest.returnMoneyAmount" maxlength="12"></div>
						</div>
						<template v-if="refund">
							<div class="am-form-group"><label class="am-form-label">类型</label>
								<div class="am-form-content">
									<input type="radio" name="radio" class="ml-3" id="returnGoods" value="2" @click="check('2')" checked/>
									<label for="returnGoods" class="">退货</label>
									<input type="radio" name="radio" class="ml-3" id="changeGoods" value="3" @click="check('3')"/>
									<label for="changeGoods" class="">换货</label>
								</div>
							</div>
							<div class="am-form-group"><label for="additionalDesp" class="am-form-label">退货说明</label>
								<div class="am-form-content"><input type="text" id="additionalDesp" :value="returnRequest.additionalDesp"></div>
							</div>
							<div class="am-form-group"><label for="returnEvidence" class="am-form-label">退货凭证</label>
								<div class="am-form-content"><input type="file" id="returnEvidence" :value="returnRequest.returnEvidence"></div>
							</div>
						</template>

						<div class="am-form-group theme-poptit">
							<div class="am-u-sm-9 am-u-sm-push-3">
								<div class="am-btn am-btn-default" @click="submit()">提交</div>
								<div class="am-btn am-btn-success" @click="backward()">取消</div>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="clear"></div>

		</div>
	</div>
</div>
<script type="text/javascript" src="static/js/utils.js" ></script>
<script type="text/javascript" src="static/js/cookie_utils.js" ></script>
<script type="text/javascript" src="static/js/vue.js" ></script>
<script type="text/javascript" src="static/js/axios.min.js" ></script>
<script type="text/javascript" src="static/js/base.js" ></script>
<script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.18.0/js/md5.js"></script>
<script type="text/javascript">
	var vm = new Vue({
		el:"#container",
		data:{
			returnRequest:{
				"orderId":"",
				"returnType":'1',
				"returnReason":"",
				"returnMoneyAmount":"",
				"additionalDesp":"",
				"returnEvidence":""
			},
			orderId:"",
			order:"",
			reconciliation:"",
			refund:1,
			money:""
		},
		created:function(){
			// this.returnRequest.orderId = "78f012fd85f74475b0a9b7e673e38fe3";
			// this.orderId = "78f012fd85f74475b0a9b7e673e38fe3";
			this.returnRequest.orderId = getUrlParam("orderId");
			this.orderId = getUrlParam("orderId");
			var url = baseUrl + "order/getOrder/"+this.orderId;
			axios({
				url: url,
				method: "get",
				headers: {
					token: getCookieValue("token")
				}
			}).then((res) => {
				if (res.data.code == 10000) {
					this.order = res.data.data;
					if(this.order.status=="2"||this.order.status=="3"){
						this.refund = 0;
						this.returnRequest.returnType='0'
					}
					console.log("订单信息",this.order);
				}
			});

			var url2 = baseUrl + "order/getReconciliation/"+this.orderId;
			axios({
				url: url2,
				method: "get",
				headers: {
					token: getCookieValue("token")
				}
			}).then((res) => {
				if (res.data.code == 10000) {
					this.reconciliation = res.data.data;
					console.log("对账金额",this.reconciliation);
					if(this.reconciliation.length>1){
						this.returnRequest.returnMoneyAmount = this.reconciliation.amountPaid;
						this.money = this.reconciliation.amountPaid;
					}else{
						this.returnRequest.returnMoneyAmount = this.order.actualAmount;
						this.money = this.order.actualAmount;
					}

				}
			});
		},
		methods: {
			check:function (value){
			    this.returnRequest.returnType = value;
			},
			backward : function (){

				window.location.href = "user-orderlist.html";
			},
			submit:function (){
				this.returnRequest.returnReason = document.getElementById("returnReason").value;
				this.returnRequest.returnMoneyAmount = document.getElementById("returnMoneyAmount").value;
				if(this.refund==1){
					this.returnRequest.additionalDesp = document.getElementById("additionalDesp").value;
					this.returnRequest.returnEvidence = document.getElementById("returnEvidence").value;
				}else{
					this.returnRequest.additionalDesp = "仅退款";
					this.returnRequest.returnEvidence = "仅退款";
				}
				if(this.returnRequest.returnMoneyAmount > this.reconciliation.amountPaid){
					alert("退款金额错误，请重新填写");
					return;
				}
				if(this.returnRequest.returnType=='2'){
					this.returnRequest.returnMoneyAmount=0;
				}
				var url3 = baseUrl + "order/returnRequest";
				axios({
					url: url3,
					method: "post",
					headers: {
						token: getCookieValue("token")
					},
					data: this.returnRequest
				}).then((res) => {
					if (res.data.code == 10000) {
						alert("提交成功！");
						var status = "";
						if(this.order.status=="2"){
							status = "12";
						}else if(this.order.status=="3")
						{
							status = "13";
						}else if(this.order.status=="4")
						{
							status = "14";
						}else if(this.order.status=="5")
						{
							status = "15";
						}else
						{
							alert("订单状态异常，请重试");
							return;
						}
						var url1 = baseUrl+"order/status/"+this.returnRequest.orderId;
						axios({
							url:url1,
							method:"put",
							headers:{
								token:getCookieValue("token")
							},
							params:{
								status:status
							}
						}).then((res)=>{
							console.log(res.data.data);
							window.location.href = "user-orderlist.html";
						});
					}
				});
			}
		},
	});

</script>
</body>

</html>